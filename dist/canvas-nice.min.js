var t,i;t=this,i=function(){const t=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/60)},i=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame||window.oCancelAnimationFrame||window.clearTimeout,s=(t,i)=>(i-t)*Math.random()+t;class h{constructor(t,i,h){this.x=s(0,t),this.y=s(0,i),this.t=s(-1,1),this.i=s(-1,1),this.size=h.point_size?s(h.point_size.min,h.point_size.max):1,this.h={touched:0,near:0,o:0},this.c={pointer_inter_type:h.pointer_inter_type,l:h.max_point_speed,r:h.point_dist,u:h.point_slow_down_rate},this.p=!1}m(){this.c.pointer_inter_type||!this.p?(this.t+=s(-.1,.1),this.i+=s(-.1,.1),this.x+=this.t,this.y+=this.i,Math.abs(this.t)>this.c.l&&(this.t*=this.c.u),Math.abs(this.i)>this.c.l&&(this.i*=this.c.u),this.p=!1):this.p=!1}M(t){return Number(Math.max(Math.min(1.2-t/this.c.r,1),.2).toFixed(1))}_(t){return 1<t?Math.pow(t-1,2):.8<t?-.04:0}v(t){const i=t.x-this.x,s=t.y-this.y,h=Math.hypot(i,s);if(h<1)return;const e=h/this.c.r;if(!(e>1.5)){if(this.p=!0,this.c.pointer_inter_type){const t=this._(e);let n={x:Math.sign(i)*t,y:Math.sign(s)*t};if(this.t+=n.x,this.i+=n.y,Math.hypot(this.x+this.t,this.y+this.i)/this.c.r<=1){const t=1-this.c.r/h;n={x:t*i,y:t*s},this.x+=n.x,this.y+=n.y,this.t=0,this.i=0}}else this.t=0,this.i=0;return{type:"l",a:this.M(h),g:[this.x,this.y,t.x,t.y]}}}$(t,i){const s=t.x-this.x,h=t.y-this.y,e=Math.hypot(s,h);if(!(e>this.c.r||e<1))return i?{type:"l",a:this.M(e),g:[this.x,this.y,t.x,t.y]}:void 0}}class e{constructor(t,i,s,h){this.x=t,this.y=i,this.w=s,this.C=h,this.points=[],this.k=!1}}class n{constructor(t,i,s){this.c=s,this.w=t,this.C=i,this.I=this.w/this.c.P,this.A=this.C/this.c.S,this.j=[],this.L(),this.T()}L(){this.j=new Array(this.c.P).fill(null).map((()=>new Array(this.c.S).fill(null)));for(let t=0;t<this.c.P;t++)for(let i=0;i<this.c.S;i++)this.j[t][i]=new e(this.I*t,this.A*i,this.I,this.A)}T(){for(let t=0;t<this.c.point_count;t++)this.V(new h(this.w,this.C,this.c))}V(t){const i=Math.floor(t.x/this.I),s=Math.floor(t.y/this.A);this.j[i][s].points.push(t)}}class o{constructor(t,i){this.line_color=i.line_color,this.line_width_multiplier=i.line_width_multiplier,this.D=t,this.D.fillStyle=`rgb(${i.point_color})`,this.F=1e3,this.N=0,this.line={buffer:new Array(9).fill(null).map((()=>[])),R:1e3,W:0},this.arc={buffer:[],R:1e3,W:0},this.rad=2*Math.PI}push(t){t&&("l"===t.type&&this.line_width_multiplier>0?(this.line.buffer[10*t.a-2].push(t.g),++this.line.W>this.line.R&&this.q()):"a"===t.type&&(this.arc.buffer.push(t.g),++this.arc.W>this.arc.R&&this.O()))}q(){for(let t=0;t<9;t++)this.B(t);this.line.W=0}B(t){let i=this.line.buffer[t];this.D.beginPath();const s=(t+2)/10;this.D.lineWidth=s*this.line_width_multiplier,this.D.strokeStyle=`rgba(${this.line_color},${s})`;for(let t=0,s=i.length;t<s;t++){const s=i[t];this.D.moveTo(s[0],s[1]),this.D.lineTo(s[2],s[3])}this.D.stroke(),this.line.buffer[t]=[]}O(){this.D.beginPath();for(let t=0;t<this.arc.buffer.length;t++){const i=this.arc.buffer[t];this.D.moveTo(i[0],i[1]),this.D.arc(i[0],i[1],i[2],0,this.rad)}this.D.fill(),this.D.stroke(),this.arc.buffer=[],this.arc.W=0}}class c{constructor(t,i,s,h){this.c=h,this.D=t,this.grid=i,this.G=s,this.H=new o(this.D,h)}async J(){for(let t=0;;t++){let i=[];if(t>=0&&t<this.c.P&&i.push(this.K(t)),t-2>=0&&t-2<this.c.P&&i.push(this.U(t-2)),t-4>=0&&t-4<this.c.P&&i.push(this.X(t-4)),0===i.length){this.H.q(),this.H.O();break}await Promise.all(i)}}async K(t){for(let i=0;i<this.c.S;i++){const s=this.grid.j[t][i];this.Y(s);const h=s.x+s.w,e=s.y+s.C;s.points.forEach((n=>{null!==this.G.x&&this.H.push(n.v(this.G));const o=n.x+this.c.point_dist>=h?1:0,c=n.y-this.c.point_dist>=s.y?-1:0,r=n.y+this.c.point_dist>=e?1:0;for(let s=0;s<=o;s++)for(let h=-c;h<=r;h++){if(0===s&&0===h)continue;if(t+s>=this.c.P||i+h<0||i+h>=this.c.S)continue;const e=this.grid.j[t+s][i+h];e.k||this.Z(e,n)}})),s.k=!0}}Y(t){for(let i=0;i<t.points.length-1;i++){const s=t.points[i];for(let h=i+1;h<t.points.length;h++){const i=t.points[h];this.H.push(s.$(i,!0)),i.$(s,!1)}}}Z(t,i){t.points.forEach((t=>{this.H.push(i.$(t,!0)),t.$(i,!1)}))}async U(t){for(let i=0;i<this.c.S;i++)this.grid.j[t][i].points.forEach((t=>{this.H.push({type:"a",g:[t.x,t.y,t.size]}),t.m()}))}async X(t){for(let i=0;i<this.c.S;i++){const s=this.grid.j[t][i];s.k=!1;const e=s.x+s.w,n=s.y+s.C;let o=[];for(let c=0;c<s.points.length;c++){const r=s.points[c];let a=0,l=0;if(r.x<s.x?a=-1:r.x>=e&&(a=1),r.y<s.y?l=-1:r.y>=n&&(l=1),0===a&&0===l)continue;const d=t+a,u=i+l;if(d<0)r.x=.1,r.t*=-1;else if(d>=this.c.P)r.x=this.grid.w-.1,r.t*=-1;else if(u<0)r.y=.1,r.i*=-1;else if(u>=this.c.S)r.y=this.grid.C-.1,r.i*=-1;else{o.push(c);const t=this.grid.j[d][u];t.points.length<this.c.chunk_capacity?t.points.push(r):this.grid.V(new h(this.grid.w,this.grid.C,this.c))}}let c=0;s.points=s.points.filter(((t,i)=>c===o.length||i!==o[c]||(c++,!1)))}}tt(){this.D.clearRect(0,0,this.grid.w,this.grid.C),this.J()}}return class{constructor(t){this.c=t,this.canvas=void 0,this.it(),this.D=this.canvas.getContext("2d"),this.grid=void 0,this.st=void 0,this.G={x:null,y:null},this.ht(),this.et={tt:!0,nt:!0,ot:.2,ct:0},this.rt()}lt(){this.canvas.width=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,this.canvas.height=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}dt(){this.et.ct=Date.now(),this.et.tt=!1,this.et.nt=!0}ht(){window.onresize=()=>{i(this.ut),this.lt(),this.dt()},-1!==this.c.pointer_inter_type&&(this.onmousemove=window.onmousemove,window.onmousemove=t=>{this.G.x=t.clientX,this.G.y=t.clientY,this.onmousemove&&this.onmousemove(t)},this.onmouseout=window.onmouseout,window.onmouseout=()=>{this.G.x=null,this.G.y=null,this.onmouseout&&this.onmouseout()})}it(){var t;this.canvas=document.createElement("canvas"),this.canvas.style.cssText=`position:fixed;top:0;left:0;z-index:${(t=this.c).zIndex};opacity:${t.opacity}`,this.lt(),document.body.appendChild(this.canvas)}wt(){const t=Math.round(this.c.point_dist*Math.max(this.c.chunk_size_constant,.25));console.log("[c-noice.js] Optimized chunk size:",t);const i=i=>{const s=s=>Math.abs(i/s-t);let h=i/t;return s(Math.floor(h))<s(Math.ceil(h))?Math.floor(h):Math.ceil(h)};this.c.P=i(this.canvas.width),this.c.S=i(this.canvas.height),console.log(`[c-noice.js] Chunk Number: ${this.c.P}*${this.c.S}`)}async rt(){this.et.tt?(this.et.nt&&(this.wt(),this.grid=new n(this.canvas.width,this.canvas.height,this.c),this.st=new c(this.D,this.grid,this.G,this.c),this.et.nt=!1,console.log(`[c-noice.js] Canvas Size: ${this.canvas.width}*${this.canvas.height}`)),this.requestFrame()):Date.now()-this.et.ct>500?(this.et.tt=!0,this.rt()):setTimeout((()=>{this.rt()}),1e3*this.et.ot)}requestFrame(){this.st.tt(),this.c.render_rate?this.ut=setTimeout((()=>{this.rt()}),1e3/this.c.render_rate):this.ut=t((()=>{this.rt()}))}ft(){i(this.ut),document.body.removeChild(this.canvas),-1!==this.c.pointer_inter_type&&(window.onmousemove=this.onmousemove,window.onmouseout=this.onmouseout)}}},"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t="undefined"!=typeof globalThis?globalThis:t||self).CanvasNice=i();
