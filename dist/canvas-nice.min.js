var t,i;t=this,i=function(){const t=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/60)},i=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame||window.oCancelAnimationFrame||window.clearTimeout,s=(t,i)=>(i-t)*Math.random()+t;class h{constructor(t,i,h){this.c=h,this.x=s(0,t),this.y=s(0,i),this.t=s(-1,1),this.i=s(-1,1),this.size=h.point_size?s(h.point_size.min,h.point_size.max):1,this.h=!1}o(){this.c.pointer_inter_type||!this.h?(this.t+=s(-.1,.1),this.i+=s(-.1,.1),this.x+=this.t,this.y+=this.i,Math.abs(this.t)>this.c.l&&(this.t*=this.c.u),Math.abs(this.i)>this.c.l&&(this.i*=this.c.u),this.h=!1):this.h=!1}p(t){return Number(Math.max(Math.min(1.2-t/this.c.r,1),.2).toFixed(1))}m(t){return 1<t?Math.pow(t-1,2)*this.c.l:.5<t?-Math.pow(1-t,2)*this.c.l:0}M(t){const i=t.x-this.x,s=t.y-this.y,h=Math.hypot(i,s);if(h<1)return;const e=h/this.c.r;if(!(e>1.5)&&(!(e>1)||this.c.pointer_inter_type)){if(this.h=!0,this.c.pointer_inter_type){if(this.c.pointer_inter_type){const t=this.m(e);let n={x:Math.sign(i)*t,y:Math.sign(s)*t};if(this.t+=n.x,this.i+=n.y,Math.hypot(this.x+this.t,this.y+this.i)/this.c.r<=1){const t=1-this.c.r/h;n={x:t*i,y:t*s},this.x+=n.x,this.y+=n.y,this.t=0,this.i=0}}}else this.t=0,this.i=0;return{type:"l",a:this.p(h),_:[this.x,this.y,t.x,t.y]}}}v(t){const i=t.x-this.x,s=t.y-this.y,h=Math.hypot(i,s);if(!(h>this.c.r||h<1))return{type:"l",a:this.p(h),_:[this.x,this.y,t.x,t.y]}}}class e{constructor(t,i,s,h){this.x=t,this.y=i,this.w=s,this.g=h,this.points=[],this.C=!1}}class n{constructor(t,i,s){this.c=s,this.pc={pointer_inter_type:s.pointer_inter_type,l:s.max_point_speed,r:s.point_dist,u:s.point_slow_down_rate},this.w=t,this.g=i,this.I=this.w/this.c.P,this.k=this.g/this.c.A,this.$=[],this.L(),this.S()}L(){this.$=new Array(this.c.P).fill(null).map((()=>new Array(this.c.A).fill(null)));for(let t=0;t<this.c.P;t++)for(let i=0;i<this.c.A;i++)this.$[t][i]=new e(this.I*t,this.k*i,this.I,this.k)}S(){for(let t=0;t<this.c.point_count;t++)this.T()}T(){const t=new h(this.w,this.g,this.pc),i=Math.floor(t.x/this.I),s=Math.floor(t.y/this.k);this.$[i][s].points.push(t)}}class o{constructor(t,i){this.line_color=i.line_color,this.line_width_multiplier=i.line_width_multiplier,this.V=t,this.V.fillStyle=`rgb(${i.point_color})`,this.V.lineCap="round",this.line={buffer:new Array(9).fill(null).map((()=>[])),D:1e3,F:0},this.arc={buffer:[],D:1e3,F:0},this.rad=2*Math.PI}push(t){t&&("l"===t.type&&this.line_width_multiplier>0?(this.line.buffer[10*t.a-2].push(t._),++this.line.F>this.line.D&&this.N()):"a"===t.type&&(this.arc.buffer.push(t._),++this.arc.F>this.arc.D&&this.R()))}N(){for(let t=0;t<9;t++)this.W(t);this.line.F=0}W(t){let i=this.line.buffer[t];this.V.beginPath();const s=(t+2)/10;this.V.lineWidth=s*this.line_width_multiplier,this.V.strokeStyle=`rgba(${this.line_color},${s})`;for(let t=0,s=i.length;t<s;t++){const s=i[t];this.V.moveTo(s[0],s[1]),this.V.lineTo(s[2],s[3])}this.V.stroke(),this.line.buffer[t]=[]}R(){this.V.beginPath();for(let t=0;t<this.arc.buffer.length;t++){const i=this.arc.buffer[t];this.V.moveTo(i[0],i[1]),this.V.arc(i[0],i[1],i[2],0,this.rad)}this.V.fill(),this.arc.buffer=[],this.arc.F=0}}class r{constructor(t,i,s,h){this.c=h,this.V=t,this.grid=i,this.j=s,this.q=new o(this.V,h)}async B(){for(let t=0;;t++){let i=[];if(t>=0&&t<this.c.P&&i.push(this.G(t)),t-2>=0&&t-2<this.c.P&&i.push(this.H(t-2)),t-4>=0&&t-4<this.c.P&&i.push(this.J(t-4)),0===i.length){this.q.N(),this.q.R();break}await Promise.all(i)}}async G(t){for(let i=0;i<this.c.A;i++){const s=this.grid.$[t][i];this.K(s);const h=s.x+s.w,e=s.y+s.g;s.points.forEach((n=>{null!==this.j.x&&this.q.push(n.M(this.j));const o=n.x+this.c.point_dist>=h?1:0,r=n.y-this.c.point_dist<s.y?-1:0,a=n.y+this.c.point_dist>=e?1:0;for(let s=0;s<=o;s++)for(let h=r;h<=a;h++){if(0===s&&0===h)continue;if(t+s>=this.c.P||i+h<0||i+h>=this.c.A)continue;const e=this.grid.$[t+s][i+h];e.C||this.O(e,n)}})),s.C=!0}}K(t){for(let i=0;i<t.points.length-1;i++){const s=t.points[i];for(let h=i+1;h<t.points.length;h++){const i=t.points[h];this.q.push(s.v(i))}}}O(t,i){t.points.forEach((t=>{this.q.push(i.v(t))}))}async H(t){for(let i=0;i<this.c.A;i++)this.grid.$[t][i].points.forEach((t=>{this.q.push({type:"a",_:[t.x,t.y,t.size]}),t.o()}))}async J(t){for(let i=0;i<this.c.A;i++){const s=this.grid.$[t][i];s.C=!1;const h=s.x+s.w,e=s.y+s.g;let n=[];for(let o=0;o<s.points.length;o++){const r=s.points[o];let a=0,c=0;if(r.x<s.x?a=-1:r.x>=h&&(a=1),r.y<s.y?c=-1:r.y>=e&&(c=1),0===a&&0===c)continue;const l=t+a,d=i+c;if(l<0)r.x*=-1,r.t*=-1;else if(l>=this.c.P)r.x=2*this.grid.w-r.x,r.t*=-1;else if(d<0)r.y*=-1,r.i*=-1;else if(d>=this.c.A)r.y=2*this.grid.g-r.y,r.i*=-1;else{n.push(o);const t=this.grid.$[l][d];t.points.length<this.c.chunk_capacity?t.points.push(r):this.grid.T()}}let o=0;s.points=s.points.filter(((t,i)=>o===n.length||i!==n[o]||(o++,!1)))}}U(){this.V.clearRect(0,0,this.grid.w,this.grid.g),this.B()}}return class{constructor(t){this.c=t,this.canvas=void 0,this.X(),this.V=this.canvas.getContext("2d"),this.grid=void 0,this.Y=void 0,this.j={x:null,y:null},this.Z(),this.tt={U:!0,it:!0,st:.2,ht:0},this.et()}nt(){this.canvas.width=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,this.canvas.height=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}ot(){this.tt.ht=Date.now(),this.tt.U=!1,this.tt.it=!0}Z(){window.onresize=()=>{i(this.rt),this.nt(),this.ot()},-1!==this.c.pointer_inter_type&&(this.onmousemove=window.onmousemove,window.onmousemove=t=>{this.j.x=t.clientX,this.j.y=t.clientY,this.onmousemove&&this.onmousemove(t)},this.onmouseout=window.onmouseout,window.onmouseout=()=>{this.j.x=null,this.j.y=null,this.onmouseout&&this.onmouseout()})}X(){var t;this.canvas=document.createElement("canvas"),this.canvas.style.cssText=`position:fixed;top:0;left:0;z-index:${(t=this.c).zIndex};opacity:${t.opacity}`,this.nt(),document.body.appendChild(this.canvas)}ct(){const t=Math.round(this.c.point_dist*Math.max(this.c.chunk_size_constant,.25)),i=i=>{const s=s=>Math.abs(i/s-t);let h=i/t;return s(Math.floor(h))<s(Math.ceil(h))?Math.floor(h):Math.ceil(h)};this.c.P=i(this.canvas.width),this.c.A=i(this.canvas.height)}async et(){this.tt.U?(this.tt.it&&(this.ct(),this.grid=new n(this.canvas.width,this.canvas.height,this.c),this.Y=new r(this.V,this.grid,this.j,this.c),this.tt.it=!1),this.requestFrame()):Date.now()-this.tt.ht>500?(this.tt.U=!0,this.et()):setTimeout((()=>{this.et()}),1e3*this.tt.st)}requestFrame(){this.Y.U(),this.c.render_rate?this.rt=setTimeout((()=>{this.et()}),1e3/this.c.render_rate):this.rt=t((()=>{this.et()}))}lt(){i(this.rt),document.body.removeChild(this.canvas),-1!==this.c.pointer_inter_type&&(window.onmousemove=this.onmousemove,window.onmouseout=this.onmouseout)}}},"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t="undefined"!=typeof globalThis?globalThis:t||self).CanvasNice=i();
