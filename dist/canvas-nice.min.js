var t,i;t=this,i=function(){const t=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/60)},i=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame||window.oCancelAnimationFrame||window.clearTimeout,s=(t,i)=>(i-t)*Math.random()+t;class h{constructor(t,i,h){this.x=s(0,t),this.y=s(0,i),this.t=s(-1,1),this.i=s(-1,1),this.size=h.point_size?s(h.point_size.min,h.point_size.max):1,this.h={touched:0,near:0,o:0},this.c={pointer_inter_type:h.pointer_inter_type,l:h.max_point_speed,r:h.point_dist,u:h.point_slow_down_rate},this.p=!1}m(){this.c.pointer_inter_type||!this.p?(this.t+=s(-.1,.1),this.i+=s(-.1,.1),this.x+=this.t,this.y+=this.i,Math.abs(this.t)>this.c.l&&(this.t*=this.c.u),Math.abs(this.i)>this.c.l&&(this.i*=this.c.u),this.p=!1):this.p=!1}M(t){return Number(Math.max(Math.min(1.2-t/this.c.r,1),.2).toFixed(1))}_(t){return 1<t?Math.pow(t-1,2)*this.c.l:.5<t?-Math.pow(1-t,2)*this.c.l:0}v(t){const i=t.x-this.x,s=t.y-this.y,h=Math.hypot(i,s);if(h<1)return;const e=h/this.c.r;if(!(e>1.5)&&(!(e>1)||this.c.pointer_inter_type)){if(this.p=!0,this.c.pointer_inter_type){if(this.c.pointer_inter_type){const t=this._(e);let n={x:Math.sign(i)*t,y:Math.sign(s)*t};if(this.t+=n.x,this.i+=n.y,Math.hypot(this.x+this.t,this.y+this.i)/this.c.r<=1){const t=1-this.c.r/h;n={x:t*i,y:t*s},this.x+=n.x,this.y+=n.y,this.t=0,this.i=0}}}else this.t=0,this.i=0;return{type:"l",a:this.M(h),g:[this.x,this.y,t.x,t.y]}}}C(t,i){const s=t.x-this.x,h=t.y-this.y,e=Math.hypot(s,h);if(!(e>this.c.r||e<1))return i?{type:"l",a:this.M(e),g:[this.x,this.y,t.x,t.y]}:void 0}}class e{constructor(t,i,s,h){this.x=t,this.y=i,this.w=s,this.I=h,this.points=[],this.P=!1}}class n{constructor(t,i,s){this.c=s,this.w=t,this.I=i,this.k=this.w/this.c.A,this.$=this.I/this.c.L,this.S=[],this.T(),this.V()}T(){this.S=new Array(this.c.A).fill(null).map((()=>new Array(this.c.L).fill(null)));for(let t=0;t<this.c.A;t++)for(let i=0;i<this.c.L;i++)this.S[t][i]=new e(this.k*t,this.$*i,this.k,this.$)}V(){for(let t=0;t<this.c.point_count;t++)this.D(new h(this.w,this.I,this.c))}D(t){const i=Math.floor(t.x/this.k),s=Math.floor(t.y/this.$);this.S[i][s].points.push(t)}}class o{constructor(t,i){this.line_color=i.line_color,this.line_width_multiplier=i.line_width_multiplier,this.F=t,this.F.fillStyle=`rgb(${i.point_color})`,this.F.lineCap="round",this.line={buffer:new Array(9).fill(null).map((()=>[])),R:1e3,W:0},this.arc={buffer:[],R:1e3,W:0},this.rad=2*Math.PI}push(t){t&&("l"===t.type&&this.line_width_multiplier>0?(this.line.buffer[10*t.a-2].push(t.g),++this.line.W>this.line.R&&this.j()):"a"===t.type&&(this.arc.buffer.push(t.g),++this.arc.W>this.arc.R&&this.q()))}j(){for(let t=0;t<9;t++)this.N(t);this.line.W=0}N(t){let i=this.line.buffer[t];this.F.beginPath();const s=(t+2)/10;this.F.lineWidth=s*this.line_width_multiplier,this.F.strokeStyle=`rgba(${this.line_color},${s})`;for(let t=0,s=i.length;t<s;t++){const s=i[t];this.F.moveTo(s[0],s[1]),this.F.lineTo(s[2],s[3])}this.F.stroke(),this.line.buffer[t]=[]}q(){this.F.beginPath();for(let t=0;t<this.arc.buffer.length;t++){const i=this.arc.buffer[t];this.F.moveTo(i[0],i[1]),this.F.arc(i[0],i[1],i[2],0,this.rad)}this.F.fill(),this.arc.buffer=[],this.arc.W=0}}class r{constructor(t,i,s,h){this.c=h,this.F=t,this.grid=i,this.B=s,this.G=new o(this.F,h)}async H(){for(let t=0;;t++){let i=[];if(t>=0&&t<this.c.A&&i.push(this.J(t)),t-2>=0&&t-2<this.c.A&&i.push(this.K(t-2)),t-4>=0&&t-4<this.c.A&&i.push(this.O(t-4)),0===i.length){this.G.j(),this.G.q();break}await Promise.all(i)}}async J(t){for(let i=0;i<this.c.L;i++){const s=this.grid.S[t][i];this.U(s);const h=s.x+s.w,e=s.y+s.I;s.points.forEach((n=>{null!==this.B.x&&this.G.push(n.v(this.B));const o=n.x+this.c.point_dist>=h?1:0,r=n.y-this.c.point_dist<s.y?-1:0,a=n.y+this.c.point_dist>=e?1:0;for(let s=0;s<=o;s++)for(let h=r;h<=a;h++){if(0===s&&0===h)continue;if(t+s>=this.c.A||i+h<0||i+h>=this.c.L)continue;const e=this.grid.S[t+s][i+h];e.P||this.X(e,n)}})),s.P=!0}}U(t){for(let i=0;i<t.points.length-1;i++){const s=t.points[i];for(let h=i+1;h<t.points.length;h++){const i=t.points[h];this.G.push(s.C(i,!0)),i.C(s,!1)}}}X(t,i){t.points.forEach((t=>{this.G.push(i.C(t,!0)),t.C(i,!1)}))}async K(t){for(let i=0;i<this.c.L;i++)this.grid.S[t][i].points.forEach((t=>{this.G.push({type:"a",g:[t.x,t.y,t.size]}),t.m()}))}async O(t){for(let i=0;i<this.c.L;i++){const s=this.grid.S[t][i];s.P=!1;const e=s.x+s.w,n=s.y+s.I;let o=[];for(let r=0;r<s.points.length;r++){const a=s.points[r];let c=0,l=0;if(a.x<s.x?c=-1:a.x>=e&&(c=1),a.y<s.y?l=-1:a.y>=n&&(l=1),0===c&&0===l)continue;const d=t+c,u=i+l;if(d<0)a.x=.1,a.t*=-1;else if(d>=this.c.A)a.x=this.grid.w-.1,a.t*=-1;else if(u<0)a.y=.1,a.i*=-1;else if(u>=this.c.L)a.y=this.grid.I-.1,a.i*=-1;else{o.push(r);const t=this.grid.S[d][u];t.points.length<this.c.chunk_capacity?t.points.push(a):this.grid.D(new h(this.grid.w,this.grid.I,this.c))}}let r=0;s.points=s.points.filter(((t,i)=>r===o.length||i!==o[r]||(r++,!1)))}}Y(){this.F.clearRect(0,0,this.grid.w,this.grid.I),this.H()}}return class{constructor(t){this.c=t,this.canvas=void 0,this.Z(),this.F=this.canvas.getContext("2d"),this.grid=void 0,this.tt=void 0,this.B={x:null,y:null},this.it(),this.st={Y:!0,ht:!0,et:.2,nt:0},this.ot()}rt(){this.canvas.width=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,this.canvas.height=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}ct(){this.st.nt=Date.now(),this.st.Y=!1,this.st.ht=!0}it(){window.onresize=()=>{i(this.lt),this.rt(),this.ct()},-1!==this.c.pointer_inter_type&&(this.onmousemove=window.onmousemove,window.onmousemove=t=>{this.B.x=t.clientX,this.B.y=t.clientY,this.onmousemove&&this.onmousemove(t)},this.onmouseout=window.onmouseout,window.onmouseout=()=>{this.B.x=null,this.B.y=null,this.onmouseout&&this.onmouseout()})}Z(){var t;this.canvas=document.createElement("canvas"),this.canvas.style.cssText=`position:fixed;top:0;left:0;z-index:${(t=this.c).zIndex};opacity:${t.opacity}`,this.rt(),document.body.appendChild(this.canvas)}dt(){const t=Math.round(this.c.point_dist*Math.max(this.c.chunk_size_constant,.25)),i=i=>{const s=s=>Math.abs(i/s-t);let h=i/t;return s(Math.floor(h))<s(Math.ceil(h))?Math.floor(h):Math.ceil(h)};this.c.A=i(this.canvas.width),this.c.L=i(this.canvas.height)}async ot(){this.st.Y?(this.st.ht&&(this.dt(),this.grid=new n(this.canvas.width,this.canvas.height,this.c),this.tt=new r(this.F,this.grid,this.B,this.c),this.st.ht=!1),this.requestFrame()):Date.now()-this.st.nt>500?(this.st.Y=!0,this.ot()):setTimeout((()=>{this.ot()}),1e3*this.st.et)}requestFrame(){this.tt.Y(),this.c.render_rate?this.lt=setTimeout((()=>{this.ot()}),1e3/this.c.render_rate):this.lt=t((()=>{this.ot()}))}ut(){i(this.lt),document.body.removeChild(this.canvas),-1!==this.c.pointer_inter_type&&(window.onmousemove=this.onmousemove,window.onmouseout=this.onmouseout)}}},"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t="undefined"!=typeof globalThis?globalThis:t||self).CanvasNice=i();
