!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t="undefined"!=typeof globalThis?globalThis:t||self).CanvasNice=i()}(this,(function(){"use strict";const t=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/60)},i=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame||window.oCancelAnimationFrame||window.clearTimeout,s=(t,i)=>(i-t)*Math.random()+t;class e{constructor(t,i,e){this.x=s(0,t),this.y=s(0,i),this.vx=s(-1,1),this.vy=s(-1,1),this.size=e.point_size?s(e.point_size.min,e.point_size.max):1,this.lazy={touched:0,near:0,sleep_frame:0},this.c={pointer_inter_type:e.pointer_inter_type,max_speed:e.max_point_speed,r:e.point_dist,slow_down:e.point_slow_down_rate},this.pointer_inter=!1}evolve(){this.c.pointer_inter_type||!this.pointer_inter?(this.vx+=s(-.1,.1),this.vy+=s(-.1,.1),this.x+=this.vx,this.y+=this.vy,Math.abs(this.vx)>this.c.max_speed&&(this.vx*=this.c.slow_down),Math.abs(this.vy)>this.c.max_speed&&(this.vy*=this.c.slow_down),this.pointer_inter=!1):this.pointer_inter=!1}calAlpha(t){return Number(Math.max(Math.min(1.2-t/this.c.r,1),.2).toFixed(1))}calPointerForce(t){return 1<t?Math.pow(t-1,2):.8<t?-.04:0}calInterWithPointer(t){const i=t.x-this.x,s=t.y-this.y,e=Math.hypot(i,s);if(e<1)return;const n=e/this.c.r;if(!(n>1.5)){if(this.pointer_inter=!0,this.c.pointer_inter_type){const t=this.calPointerForce(n);let h={x:Math.sign(i)*t,y:Math.sign(s)*t};this.vx+=h.x,this.vy+=h.y;if(Math.hypot(this.x+this.vx,this.y+this.vy)/this.c.r<=1){const t=1-this.c.r/e;h={x:t*i,y:t*s},this.x+=h.x,this.y+=h.y,this.vx=0,this.vy=0}}else this.vx=0,this.vy=0;return{type:"l",a:this.calAlpha(e),pos_info:[this.x,this.y,t.x,t.y]}}}calInterWithPoint(t,i){const s=t.x-this.x,e=t.y-this.y,n=Math.hypot(s,e);if(!(n>this.c.r||n<1))return i?{type:"l",a:this.calAlpha(n),pos_info:[this.x,this.y,t.x,t.y]}:void 0}}class n{constructor(t,i,s,e){this.x=t,this.y=i,this.w=s,this.h=e,this.points=[],this.traversed=!1}}class h{constructor(t,i,s){this.c=s,this.w=t,this.h=i,this.chunk_w=this.w/this.c.X_CHUNK,this.chunk_h=this.h/this.c.Y_CHUNK,this.chunks=[],this.genChunks(),this.initializePoints()}genChunks(){this.chunks=new Array(this.c.X_CHUNK).fill(null).map((()=>new Array(this.c.Y_CHUNK).fill(null)));for(let t=0;t<this.c.X_CHUNK;t++)for(let i=0;i<this.c.Y_CHUNK;i++)this.chunks[t][i]=new n(this.chunk_w*t,this.chunk_h*i,this.chunk_w,this.chunk_h)}initializePoints(){for(let t=0;t<this.c.point_count;t++)this.insertPoint(new e(this.w,this.h,this.c))}insertPoint(t){const i=Math.floor(t.x/this.chunk_w),s=Math.floor(t.y/this.chunk_h);this.chunks[i][s].points.push(t)}}class o{constructor(t,i){this.line_color=i.line_color,this.line_width_multiplier=i.line_width_multiplier,this.ctx=t,this.ctx.fillStyle=`rgb(${i.point_color})`,this.max_capacity=1e3,this.cur_capacity=0,this.line={buffer:new Array(9).fill(null).map((()=>[])),max_cap:1e3,cur_cap:0},this.arc={buffer:[],max_cap:1e3,cur_cap:0},this.rad=2*Math.PI}push(t){t&&("l"===t.type&&this.line_width_multiplier>0?(this.line.buffer[10*t.a-2].push(t.pos_info),++this.line.cur_cap>this.line.max_cap&&this.dumpLine()):"a"===t.type&&(this.arc.buffer.push(t.pos_info),++this.arc.cur_cap>this.arc.max_cap&&this.dumpArc()))}dumpLine(){for(let t=0;t<9;t++)this.dumpLineSlot(t);this.line.cur_cap=0}dumpLineSlot(t){let i=this.line.buffer[t];this.ctx.beginPath();const s=(t+2)/10;this.ctx.lineWidth=s*this.line_width_multiplier,this.ctx.strokeStyle=`rgba(${this.line_color},${s})`;for(let t=0,s=i.length;t<s;t++){const s=i[t];this.ctx.moveTo(s[0],s[1]),this.ctx.lineTo(s[2],s[3])}this.ctx.stroke(),this.line.buffer[t]=[]}dumpArc(){this.ctx.beginPath();for(let t=0;t<this.arc.buffer.length;t++){const i=this.arc.buffer[t];this.ctx.moveTo(i[0],i[1]),this.ctx.arc(i[0],i[1],i[2],0,this.rad)}this.ctx.fill(),this.ctx.stroke(),this.arc.buffer=[],this.arc.cur_cap=0}}class r{constructor(t,i,s,e){this.c=e,this.ctx=t,this.grid=i,this.pointer=s,this.draw_buffer=new o(this.ctx,e)}async traverse(){for(let t=0;;t++){let i=[];if(t>=0&&t<this.c.X_CHUNK&&i.push(this.calVerticalInteraction(t)),t-2>=0&&t-2<this.c.X_CHUNK&&i.push(this.evolveVerticalChunks(t-2)),t-4>=0&&t-4<this.c.X_CHUNK&&i.push(this.updateVerticalChunks(t-4)),0===i.length){this.draw_buffer.dumpLine(),this.draw_buffer.dumpArc();break}await Promise.all(i)}}async calVerticalInteraction(t){for(let i=0;i<this.c.Y_CHUNK;i++){const s=this.grid.chunks[t][i];this.calLocalInteraction(s);const e=s.x+s.w,n=s.y+s.h;s.points.forEach((h=>{null!==this.pointer.x&&this.draw_buffer.push(h.calInterWithPointer(this.pointer));const o=h.x+this.c.point_dist>=e?1:0,r=h.y-this.c.point_dist>=s.y?-1:0,c=h.y+this.c.point_dist>=n?1:0;for(let s=0;s<=o;s++)for(let e=-r;e<=c;e++){if(0===s&&0===e)continue;if(t+s>=this.c.X_CHUNK||i+e<0||i+e>=this.c.Y_CHUNK)continue;const n=this.grid.chunks[t+s][i+e];n.traversed||this.calSurroundingInteraction(n,h)}})),s.traversed=!0}}calLocalInteraction(t){for(let i=0;i<t.points.length-1;i++){const s=t.points[i];for(let e=i+1;e<t.points.length;e++){const i=t.points[e];this.draw_buffer.push(s.calInterWithPoint(i,!0)),i.calInterWithPoint(s,!1)}}}calSurroundingInteraction(t,i){t.points.forEach((t=>{this.draw_buffer.push(i.calInterWithPoint(t,!0)),t.calInterWithPoint(i,!1)}))}async evolveVerticalChunks(t){for(let i=0;i<this.c.Y_CHUNK;i++){this.grid.chunks[t][i].points.forEach((t=>{this.draw_buffer.push({type:"a",pos_info:[t.x,t.y,t.size]}),t.evolve()}))}}async updateVerticalChunks(t){for(let i=0;i<this.c.Y_CHUNK;i++){const s=this.grid.chunks[t][i];s.traversed=!1;const n=s.x+s.w,h=s.y+s.h;let o=[];for(let r=0;r<s.points.length;r++){const c=s.points[r];let a=0,l=0;if(c.x<s.x?a=-1:c.x>=n&&(a=1),c.y<s.y?l=-1:c.y>=h&&(l=1),0===a&&0===l)continue;const d=t+a,u=i+l;if(d<0)c.x=.1,c.vx*=-1;else if(d>=this.c.X_CHUNK)c.x=this.grid.w-.1,c.vx*=-1;else if(u<0)c.y=.1,c.vy*=-1;else if(u>=this.c.Y_CHUNK)c.y=this.grid.h-.1,c.vy*=-1;else{o.push(r);const t=this.grid.chunks[d][u];t.points.length<this.c.chunk_capacity?t.points.push(c):this.grid.insertPoint(new e(this.grid.w,this.grid.h,this.c))}}let r=0;s.points=s.points.filter(((t,i)=>r===o.length||i!==o[r]||(r++,!1)))}}draw(){this.ctx.clearRect(0,0,this.grid.w,this.grid.h),this.traverse()}}return class{constructor(t){this.c=t,this.canvas=void 0,this.initializeCanvas(),this.ctx=this.canvas.getContext("2d"),this.grid=void 0,this.simulator=void 0,this.pointer={x:null,y:null},this.registerListener(),this.render={draw:!0,need_initialize:!0,delay_after:.2,last_changed_time:0},this.pendingRender()}updateCanvasSize(){this.canvas.width=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,this.canvas.height=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}resetRenderInfo(){this.render.last_changed_time=Date.now(),this.render.draw=!1,this.render.need_initialize=!0}registerListener(){window.onresize=()=>{i(this.tid),this.updateCanvasSize(),this.resetRenderInfo()},this.onmousemove=window.onmousemove,window.onmousemove=t=>{this.pointer.x=t.clientX,this.pointer.y=t.clientY,this.onmousemove&&this.onmousemove(t)},this.onmouseout=window.onmouseout,window.onmouseout=()=>{this.pointer.x=null,this.pointer.y=null,this.onmouseout&&this.onmouseout()}}initializeCanvas(){var t;this.canvas=document.createElement("canvas"),this.canvas.style.cssText=`position:fixed;top:0;left:0;z-index:${(t=this.c).zIndex};opacity:${t.opacity}`,this.updateCanvasSize(),document.body.appendChild(this.canvas)}optimizeChunkSize(){const t=Math.round(this.c.point_dist*Math.max(this.c.chunk_size_constant,.25));console.log("[c-noice.js] Optimized chunk size:",t);const i=i=>{const s=s=>Math.abs(i/s-t);let e=i/t;return s(Math.floor(e))<s(Math.ceil(e))?Math.floor(e):Math.ceil(e)};this.c.X_CHUNK=i(this.canvas.width),this.c.Y_CHUNK=i(this.canvas.height),console.log(`[c-noice.js] Chunk Number: ${this.c.X_CHUNK}*${this.c.Y_CHUNK}`)}async pendingRender(){this.render.draw?(this.render.need_initialize&&(this.optimizeChunkSize(),this.grid=new h(this.canvas.width,this.canvas.height,this.c),this.simulator=new r(this.ctx,this.grid,this.pointer,this.c),this.render.need_initialize=!1,console.log(`[c-noice.js] Canvas Size: ${this.canvas.width}*${this.canvas.height}`)),this.requestFrame()):Date.now()-this.render.last_changed_time>500?(this.render.draw=!0,this.pendingRender()):setTimeout((()=>{this.pendingRender()}),1e3*this.render.delay_after)}requestFrame(){this.simulator.draw(),this.tid=t((()=>{this.pendingRender()}))}destroy(){window.onmousemove=this.onmousemove,window.onmouseout=this.onmouseout,i(this.tid),document.body.removeChild(this.canvas)}}}));
